#!/usr/bin/env bash

set -euxo pipefail

export PATH="/builder/image.d:$PATH"

rootfs_work="$(mktemp -d)"
mount -t tmpfs tmpfs "$rootfs_work"

MYROOT="$(mktemp -d)"
mount -t tmpfs tmpfs "$MYROOT"
mkdir -p "$MYROOT"/sysroot
OSTREE_SYSROOT="$MYROOT/sysroot"
OSTREE_REPO=$OSTREE_SYSROOT/ostree/repo
OSTREE_REF="gardenlinux/today/$BUILDER_ARCH"

# BUILD_VARIANT determains which repo we need to download (like metal, kvm, gcp, aws, azure, ..)
BUILD_VARIANT=$([ -f /builder/features/ostreeRepo/BUILD_VARIANT ] && cat /builder/features/ostreeRepo/BUILD_VARIANT || echo '')
# Use kvm as default variant when nothing is configured
BUILD_VARIANT="${BUILD_VARIANT:-kvm}"
REMOTE_URL="http://ostree.gardenlinux.io"
REMOTE_ARCHIVE_NAME=ostree-gardenlinux-repo-${BUILD_VARIANT}-${BUILDER_ARCH}.tar.gz
REMOTE_NAME=gardenlinux-repo-${BUILD_VARIANT}-${BUILDER_ARCH}

rootfs="$1"
output="$2"

echo Building variant $BUILD_VARIANT

tar xf "$rootfs" -C "$rootfs_work"

mv "$rootfs_work"/etc "$rootfs_work"/usr/etc

mkdir -p $OSTREE_REPO

if curl --head --silent --fail $REMOTE_URL/$REMOTE_ARCHIVE_NAME 2> /dev/null;
 then
    echo "Using $REMOTE_URL/$REMOTE_ARCHIVE_NAME"
    mkdir -p $OSTREE_REPO
    download="$(mktemp -d)"
    pushd $download
    curl -fsSL --remote-name $REMOTE_URL/$REMOTE_ARCHIVE_NAME
    tar xf $REMOTE_ARCHIVE_NAME --directory $OSTREE_REPO
    popd
    rm -rf $download
 else
    echo "Coud not download $REMOTE_URL/$REMOTE_ARCHIVE_NAME, building new repo"
    ostree init --mode=archive --repo=$OSTREE_REPO
    ostree admin init-fs --modern $OSTREE_SYSROOT
    ostree admin os-init --sysroot=$OSTREE_SYSROOT gardenlinux
    ostree config --repo=$OSTREE_REPO set sysroot.bootloader none
fi

ostree remote --repo=$OSTREE_REPO delete --if-exists origin
ostree remote --repo=$OSTREE_REPO add --no-gpg-verify --no-sign-verify origin $REMOTE_URL/$REMOTE_NAME $OSTREE_REF

ostree commit --repo=$OSTREE_REPO --branch $OSTREE_REF --skip-if-unchanged -s "Garden Linux $BUILD_VARIANT $(date --utc +%Y-%m-%dT%H:%M%Z)" "$rootfs_work"

ostree log --repo=$OSTREE_REPO $OSTREE_REF

ostree summary --update --repo=$OSTREE_REPO

ostree summary --view --repo=$OSTREE_REPO

tar --directory $OSTREE_REPO --create --mtime="@$BUILDER_TIMESTAMP" --sort name --numeric-owner --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=atime,delete=ctime . | gzip > "$output"
